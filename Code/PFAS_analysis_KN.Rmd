---
title: "PFAS_analysis_KN"
author: "Karly Nocera and Tay Holiday"
date: "4/16/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
# Set your working directory

getwd()

# Load your packages

library(tidyverse)
library(lubridate)

# Set your ggplot theme

mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")

theme_set(mytheme)

# Load your datasets
PFAS_WWTP_clean <- read.csv("./Data/Processed/PFAS_WWTP_clean.csv", stringsAsFactors = TRUE)

PFAS_WWTP_wide_clean <- read.csv("./Data/Processed/PFAS_WWTP_wide_clean.csv", stringsAsFactors = TRUE)

PFAS_Source_clean <- read.csv("./Data/Processed/PFAS_Source_clean.csv", stringsAsFactors = TRUE)

PFAS_Source_wide_clean <- read.csv("./Data/Processed/PFAS_Source_wide_clean.csv", stringsAsFactors = TRUE)

```


# Analysis

Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.

Each figure should be accompanied by a caption, and each figure should be referenced within the text




## Question 1: Source Data Analytes

### Question 1a: Long v Short

```{r}

# want to know what type of remediation is needed to deal with their contamination (GAC short chain; RO both)

ggplot(subset(PFAS_WWTP_clean, !is.na(ppt)), aes(x = Site, y = ppt))+
  geom_col(aes(fill = chain.length)) +
  labs(fill = "Chain Length") +
  xlab("WWTP Site") +
  theme(axis.text.x = element_text(angle = 90,  hjust = 1))


ggplot(subset(PFAS_Source_clean, !is.na(ppt)), aes(x = Site, y = ppt))+
  geom_col(aes(fill = chain.length)) +
  labs(fill = "Chain Length") +
  xlab("Source Site") +
  theme(axis.text.x = element_text(angle = 90,  hjust = 1))

```

### Question 1b: Top 5 Analytes

```{r}

# plot analytes by site shows the only analytes worth knowing

ggplot(subset(PFAS_long_clean, Type == "Source"), aes(fill=Analyte, y=ppt, x=Site)) +     geom_bar(position="stack", stat="identity") +
    labs(fill = "Analyte") +
    theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab("Source Sites")

```


### Question 1c: Are there rivers that are scary we aren't talking about? (high and type of analyte)

```{r}

# PROBLEM: wide dataset shows 8 sites with PFAS, long shows 11

# decide top sites to plot

topsites <-
  PFAS_wide_clean %>%
  filter(Type =="Source") %>%
  select(Type, Site, TotalPFAS)


topsites <- topsites[with(topsites,order(-TotalPFAS)),]

topsites <- topsites[1:8,]


# facet wrap each site by x = analyte y = ppt

ggplot(topsites, aes(x = Site, y = TotalPFAS)) + 
  geom_bar(stat="identity") +
  facet_wrap(vars(Site), nrow = 5) +
  ylab("Total PFAS (ppt)") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) 

```

### Question 1d: [Tay] Are any spots with one analyte over 70? over 30?

```{r}
#Any locations with Analyte above 30? 70?
#To do this, a simple pipe should do to filter out which analytes/site are above the given value.
#EPA_Processed_2018$Result <- subset(EPA_Processed_2018$Result, !is.na()) #converts the result into a numeric value instead of a factor

source_analyte_above_30 <- 
  PFAS_long_clean %>%
  filter(Type == "Source") %>%
  filter(ppt > 30)

source_analyte_above_70 <- 
  PFAS_long_clean %>%
  filter(Type == "Source") %>%
  filter(ppt > 70)

unique(source_analyte_above_30$Site) #11 Sites above 30 
unique(source_analyte_above_70$Site) #5 sites above 70



pfoapfos.source <- 
  ggplot(PFAS_wide_clean, aes(x = Site, y = sum_pfoa.pfos)) +
  geom_hline(yintercept = 70, lty = 2) +
  geom_point(alpha = 0.5, size = 1.5) +
  ylim(0,150) +
  ylab(expression("PPT")) +
  theme(axis.text.x = element_blank())

total.source <- 
  ggplot(PFAS_wide_clean, aes(x = Site, y = sum_pfas)) +
  geom_hline(yintercept = 20, lty = 2) +
  geom_hline(yintercept = 70, lty = 2) +
  geom_point(alpha = 0.5, size = 1.5) +
  ylim(0,150) +
  ylab(expression("PPT")) +
  theme(axis.text.x = element_blank())

print(pfoapfos.source)

print(total.source)


â˜»```


### Question 1e: [Tay] Total PFAS over 130

```{r}

#Total PFAS over 130

# sum of pfas for every source site at that date
# filter for those over 130
# unique for how many sites had total pfas over 130

Total_PFAS_Source_Over130 <- 
  PFAS_wide_clean %>%
  filter (Type == "Source") %>%
  filter (sum_pfas > 130)

## hey, Tay. Do this. Please :) 

# rename without dashes

rename(PFAS_wide_clean, petal_length = Petal.Length)

PFAS_wide_clean <-
  PFAS_wide_clean %>%
  mutate(TotalPFAS = (PFBA + PFBS + PFDS + PFDA + PFDoA + PFHpS + PFHpA + PFHxS + PFHxA + PFNS + PFNA + PFOSA + N.EtFOSAA + N.MeFOSAA + PFPeS + PFPeA + PFTeA + PFTriA + PFUnA + HFPO.DA + PFOA + PFOS), na.rm=TRUE)

PFAS_wide_sum <-
  PFAS_wide_clean %>%
  mutate(TotalPFAS = (PFBA + PFBS + PFDS + PFDA + PFDoA + PFHpS + PFHpA + PFHxS + PFHxA + PFNS + PFNA + PFOSA + N.EtFOSAA + N.MeFOSAA + PFPeS + PFPeA + PFTeA + PFTriA + PFUnA + HFPO.DA + PFOA + PFOS, na.rm=TRUE))

PFAS_wide_sum <-
  PFAS_wide_clean %>%
  mutate(TotalPFAS = sum(PFBA:PFOS, na.rm=TRUE))

PFAS_wide_sum

#YAY! Got it!

```

## Question 2: Source Data ND/Qualifiers

### Question 2a: [Tay] Summary Stats: ND below 5; ND below 10; ND below 20 (distrubtion bell curve)

```{r}



```



### Question 2b: [Tay] Percentages (how many ND / total detections under 30) within any. Within GenX. See how many of which analytes have the worst percentage rations --> play with those trends

```{r}

```


### Question 2c: [Tay] ND: Variability of lab qualifiers (know the level is above/below U) - by analyte per Source

```{r}

```



## Question 3: WWTP Analytes

### Question 3a: PFOA, PFOS, GenX, sum PFAS accross sites

```{r}


# tried facet wrap

wwtp_pfoa.pfos.genx <-
  PFAS_long_clean %>%
  filter(Analyte %in% c("PFOA", "PFOS", "HFPO-DA")) %>%
  filter(Type =="WWTP")

# add month column
wwtp_pfoa.pfos.genx$Sample.Date <-
  ymd(wwtp_pfoa.pfos.genx$Sample.Date)

wwtp_pfoa.pfos.genx <- 
  mutate(wwtp_pfoa.pfos.genx, month = month(Sample.Date)) 

#facet wrap by month

ggplot(wwtp_pfoa.pfos.genx, aes(x=Analyte, y=ppt)) +
  geom_bar(position="stack", stat="identity") +
  facet_grid(Site ~ month)

# fewer sites


### TRY 2 -- need to convert HFPO-DA to HFPO.DA and run again

ggplot(wwtp_pfoa.pfos.genx, aes(x = Site, y = ppt))+
  geom_col(aes(fill = Analyte)) +
  labs(fill = "Analyte") +
  ylim(0,4500) +
  xlab("WWTP Site") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```


### Question 3b: Top analytes (aka are there analytes we aren't looking at)
```{r}

# plot analytes by site shows the only analytes worth knowing

ggplot(subset(PFAS_long_clean, Type == "WWTP"), aes(fill=Analyte, y=ppt, x=Site)) +     geom_bar(position="stack", stat="identity") +
    labs(fill = "Analyte") +
    theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab("WWTP Sites")

# summarise  by column and get highest mean value

mean_analyte <-
  colMeans(PFAS_wide_clean[sapply(PFAS_wide_clean, is.numeric)], na.rm=TRUE) 

mean_analyte <- data.frame(mean_analyte)

mean_analyte <-
  mean_analyte %>%
  filter(lakename == "Paul Lake" | lakename == "Peter Lake")

```


### Question 3d: Long vs Short

```{r}


# group by chain length in Q1
# pfas_chain_group <-
  #PFAS_long_clean %>%
  #drop_na(ppt) %>%
  #group_by(Type, Site, chain.length) %>%
  #summarise(ppt = sum(ppt))

# bar plot stacked
ggplot(subset(pfas_chain_group, Type == "WWTP"), aes(x = Site, y = ppt))+
  geom_col(aes(fill = chain.length)) +
  labs(fill = "Chain Length") +
  xlab("WWTP Site") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


```

### Question 3e: [Tay] Are any spots with one analyte over 70? over 30?

```{r}

wwtp_analyte_above_30 <- 
  PFAS_WWTP_clean %>%
  filter(ppt > 30)

wwtp_analyte_above_70 <- 
  PFAS_WWTP_clean %>%
  filter(ppt > 70)

source_analyte_above_30 <- 
  PFAS_Source_clean %>%
  filter(ppt > 30)

source_analyte_above_70 <- 
  PFAS_Source_clean %>%
  filter(ppt > 70)

unique(wwtp_analyte_above_30$Site) #27 Sites above 30 
unique(wwtp_analyte_above_70$Site) #13 sites above 70

unique(source_analyte_above_30$Site) #11 Sites above 30 
unique(source_analyte_above_70$Site) #5 sites above 70

```

### Question 1e: [Tay] Total PFAS over 130

```{r}

```





## Question 4: WWTP ND/Qualifiers

### Question 4a: [Tay] Summary Stats: ND below 5; ND below 10; ND below 20 (distrubtion bell curve)

```{r}

```

### Question 4b: [Tay] Percentages (how many ND / total detections under 30) within any. Within GenX. See how many of which analytes have the worst percentage rations --> play with those trends

```{r}

```

### Question 4c: [Tay] ND: Variability of lab qualifiers (know the level is above/below U) - by analyte per WWTP

```{r}

```


### LIT REVIEW 

# Total PFAS date v ppt by site (lines or facet)

```{r}

PFAS_WWTP_wide_clean$Sample.Date <- ymd(PFAS_WWTP_wide_clean$Sample.Date)

ggplot(PFAS_WWTP_wide_clean, aes(x=Sample.Date, y = TotalPFAS, group=Site)) +
  geom_line(aes(color=Site)) +
  geom_point(aes(color=Site)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y")

# or

PFAS_WWTP_wide_clean <-
  PFAS_WWTP_wide_clean %>%
  mutate(month = month(Sample.Date))

ggplot(PFAS_WWTP_wide_clean, aes(x=month, y = TotalPFAS, group=Site)) +
  geom_line(aes(color=Site)) +
  geom_point(aes(color=Site)) +
  scale_x_continuous(breaks=c(7, 8, 9)) +
  ylab("Total PFAS (ppt)") +
  xlab("2019 Month") +
  theme(legend.position="right")

```

# Analytes by site (bar) with line at 70

```{r}

ggplot(PFAS_WWTP_clean, aes(fill=Analyte, x=Site, y=ppt)) +
  geom_bar(position="stack", stat="identity") +
  labs(fill = "Analyte") +
  geom_hline(yintercept = 70, lty = 2) +
  ylim(0,5000) +
  ylab("Total PFAS (ppt)") +
  xlab("WWTP Site") +
  geom_text(x = "City.of.Graham", y = 45, label = "70 ppt", hjust = 1, fontface = "bold")  +
  theme(axis.text.x = element_text(angle = 90,  hjust = 1),
    legend.position="right")


ggplot(subset(PFAS_Source_clean, !is.na(ppt)), aes(fill=Analyte, x=Site, y=ppt)) +
  geom_bar(position="stack", stat="identity") +
  labs(fill = "Analyte") +
  geom_hline(yintercept = 70, lty = 2) +
  ylim(0,3000) +
  ylab("Total PFAS (ppt)") +
  xlab("Source Site") +
  geom_text(x = "NORTHEASTCRKATSR1731OKELLYCHURCHRDNRDURHAM", y = 45, label = "70 ppt", hjust = 1, fontface = "bold")  +
  theme(axis.text.x = element_text(angle = 90,  hjust = 1),
    legend.position="right")

```

# Analytes over date and ppt

```{r}

```

# Compare PFOA/PFOS and Total (stacked bar)

```{r}

PFAS_WWTP_wide_clean <-
  PFAS_WWTP_wide_clean %>%
  mutate(nonPFOA.PFOS = (TotalPFAS-SumPFOA.PFOS))

6.2

WWTP_sum.total <-
  PFAS_WWTP_clean %>%
  filter(Analyte %in% c("PFOA", "PFOS", "PFBA", "PFHxA", "PFNA", "PFBS", "PFHpA", "PFPeA"))

cols <- c(PFOA="blue", PFOS="blue", PFBA="black", PFHxA="black", PFNA="black", PFBS="black", PFHpA="black", PFPeA="black")

ggplot(WWTP_sum.total, aes(x=Site, y=ppt, fill=Analyte)) +
  geom_bar(stat="identity", position = "dodge") +
  scale_fill_manual(values = cols) +
  xlab("WWTP Site")+
  theme(axis.text.x = element_text(angle = 90,  hjust = 1),
    legend.position="right")
```

