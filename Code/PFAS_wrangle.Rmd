---
title: "PFAS_wrangle"
author: "Karly Nocera and Tay Holliday"
date: "4/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
# Set your working directory

getwd()

# Load your packages

library(tidyverse)
library(lubridate)

# Set your ggplot theme

mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")
theme_set(mytheme)

# Load your datasets
PFAS_long <- read.csv("../Data/Processed/CombinedDatasets_long_cleaned_time.csv", stringsAsFactors = TRUE)

PFAS_wwtp_wide_july <- read.csv("../Data/Processed/2019_WWTP_July.csv", stringsAsFactors = TRUE)
PFAS_wwtp_wide_aug <- read.csv("../Data/Processed/2019_WWTP_Aug.csv", stringsAsFactors = TRUE)
PFAS_wwtp_wide_sep <- read.csv("../Data/Processed/2019_WWTP_Sept.csv", stringsAsFactors = TRUE)

PFAS_source_wide <- read.csv("../Data/Processed/2018_PublicSupply_wide_latlong.csv", stringsAsFactors = TRUE)

```


#combine wide

```{r}
# create wide ISSUES MAKING EACH SITE *AND* BY DATE *AND WITH DUPLLICATE LAB QUALIFIER*
#PFAS_wide <- pivot_wider(PFAS_clean, names_from = Analyte, values_from = ppt)

PFAS_wide_wwtp <- rbind(PFAS_wwtp_wide_july, PFAS_wwtp_wide_aug, PFAS_wwtp_wide_sep)

PFAS_wide_combined <- full_join(PFAS_wide_wwtp, PFAS_source_wide)

# if doing through R, remember to add sum PFOA/PFOS and total PFAS columns
```
```{r}
### DONT RUN UNTIL FIX SCRIPT

## PFAS wide needs site type

long_site <- 
  PFAS_long %>%
  select(Type, Site)

long_distict_site <-
  long_site %>% distinct()

### HELP THIS ISN'T WORKING
PFAS_wide_combined <- 
  semi_join(long_site, PFAS_wide_combined, by = "Site")

# Until the join works, use manual excel (brought in the beginning)

```


```{r}
#convert dates
PFAS_long$Sample.Date <- mdy(PFAS_long$Sample.Date)

PFAS_wide_combined$Sample.Date <- mdy(PFAS_wide_combined$Sample.Date)

```
```{r}
# remove Sum and Total rows
PFAS_long <- PFAS_long[!grepl("Sum",PFAS_long$Analyte),]
PFAS_long <- PFAS_long[!grepl("Total",PFAS_long$Analyte),]

```

```{r}
# only keep the analytes we care about in long

#unique(PFAS_clean$Analyte)

# STILL TO DO ((NOTE CURRENT ANALYSES WRONG WITHOUT THIS))
# convert 
# "PFTeA (PFTA)" and "PFTeA/PFTeDA" to "PFTeA"
# "PFTriA (PFTrA)" and "PFTriA/PFTrDA" to PFTriA
# "PFUnA/PFUdA" to PFUnA
# "HFPO-DA (GenX)" and "NaDONA/GENx" to HFPO


### THIS ISN'T THE RIGHT WAY TO REMOVE?? they disappear but not removed from dataset, as seen in 'summary'
PFAS_long_clean <-
  PFAS_long %>%
  filter(Analyte %in% c("PFBA", "PFBS", "PFDS", "PFDA", "PFDoA", "PFHpS", "PFHpA", "PFHxS", "PFHxA", "PFNS", "PFNA", "PFOSA", "N-EtFOSAA", "N-MeFOSAA", "PFPeS", "PFPeA", "PFTeA", "PFTriA", "PFUnA", "HFPO-DA", "PFOA", "PFOS"))
```

# chain lengths

```{r}

#Creates a function to determine if Analyte is short or long
chain.length.function <- function(x){
    ifelse(x %in% c("PFBA","PFBS","PFHpA","PFHxA","PFPeS","PFPeA","4:2 FTS"), "short", "long")}

#Makes a chain.length column in the long data Set
PFAS_long_clean <- PFAS_long_clean %>%
  mutate(chain.length = chain.length.function(Analyte)) 

# make chain length in wide data set
PFAS_wide_clean <- 
    PFAS_wide_clean %>% 
    rowwise() %>% 
    mutate(short.ppt = sum(PFBA, PFBS, PFHpA, PFHxA, PFPeS, PFPeA, na.rm = TRUE)) %>%
    mutate(long.ppt = sum(PFDS, PFDA, PFDoA, PFHpS, PFHxS, PFNS, PFNA, PFOSA, N.EtFOSAA, N.MeFOSAA, PFTeA, PFTriA, PFUnA, HFPO.DA, PFOA, PFOS, na.rm = TRUE))

```

```{r}

# add Total PFAS to wide

PFAS_wide_clean <- PFAS_wide_combined %>%
  mutate(TotalPFAS = sum(short.ppt, long.ppt, na.rm=TRUE)) 

```


# still to do
## PFAS long needs lat/long


# save processed files

```{r}

# bound PFAS_wide

write.csv(PFAS_wide_clean, row.names=FALSE, file = "./Data/Processed/PFAS_wide_clean.csv")

# PFAS_clean(er)

write.csv(PFAS_long_clean, row.names=FALSE, file = "./Data/Processed/PFAS_long_clean.csv")

```

